# Voice Features Setup Guide

This guide shows you how to start Pearl's voice features **without Redis** (simplest setup).

## Prerequisites

1. **Node.js** (v20+)
2. **PostgreSQL** (local or Docker)
3. **Python 3.11+** with Poetry (for bot)
4. **Daily.co API Key** (free tier works)
5. **OpenAI API Key** (for LLM)
6. **Deepgram API Key** (for speech-to-text)

## Quick Start (3 Steps)

### Step 1: Install Dependencies

```bash
# From project root
npm install

# Pull Chorus TTS submodule (for Kokoro TTS)
git submodule update --init --recursive

# Download Kokoro TTS assets (optional, auto-downloads if missing)
npm run chorus:download-assets
```

### Step 2: Configure Environment

Create `.env.local` in the project root with:

```bash
# Required for voice
DAILY_API_KEY=your_daily_api_key_here
OPENAI_API_KEY=your_openai_api_key_here
DEEPGRAM_API_KEY=your_deepgram_api_key_here

# Bot configuration (defaults work for local dev)
BOT_CONTROL_BASE_URL=http://localhost:4444
NEXT_PUBLIC_BOT_CONTROL_BASE_URL=http://localhost:4444
BOT_CONTROL_SHARED_SECRET=your_secret_here
BOT_CONTROL_AUTH_REQUIRED=0  # Set to 0 for local dev

# Redis is OFF by default (no Redis needed!)
USE_REDIS=false

# Database (required)
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=password
POSTGRES_DB=testdb

# Auth secrets (auto-generated by setup script)
NEXTAUTH_SECRET=your_secret_here
TOKEN_ENCRYPTION_KEY=your_key_here
```

**For the bot** (`apps/pipecat-daily-bot/.env`):

```bash
# Required
DAILY_API_KEY=your_daily_api_key_here
OPENAI_API_KEY=your_openai_api_key_here
DEEPGRAM_API_KEY=your_deepgram_api_key_here

# Redis OFF (default)
USE_REDIS=false

# TTS Provider (Kokoro is free, local)
# Note: Chorus TTS must be running separately (see Step 3)
BOT_TTS_PROVIDER=kokoro
# KOKORO_TTS_API_KEY is optional for local Chorus (auto-uses "test-key" if not set)
KOKORO_TTS_BASE_URL=ws://127.0.0.1:8000
KOKORO_TTS_VOICE_ID=af_heart
```

### Step 3: Start Everything

**You need 2 terminals:**

**Terminal 1: Main Platform + Chorus TTS**
```bash
# This starts Interface, Mesh, Dashboard, AND Chorus TTS
npm run start:all
```

**Terminal 2: Bot Gateway**
```bash
cd apps/pipecat-daily-bot
npm run dev
```

> **Note:** Chorus TTS is automatically started by `npm run start:all` via the `chorus:start` script. You don't need to start it separately.

**Option B: Step-by-Step (for debugging)**

```bash
# Terminal 1: Start Chorus TTS (Kokoro) - if not started by start:all
npm run chorus:start

# Terminal 2: Start main platform (Interface, Mesh, Dashboard)
npm run start:all

# Terminal 3: Start bot gateway (no separate runner needed when USE_REDIS=false)
cd apps/pipecat-daily-bot
npm run dev
```

## What Gets Started

### Terminal 1 (`npm run start:all`):
- âœ… **Interface** (http://localhost:3000)
- âœ… **Mesh GraphQL** (http://localhost:2000/graphql)
- âœ… **Dashboard** (http://localhost:4000)
- âœ… **Chorus TTS** (ws://127.0.0.1:8000) - Kokoro voice

### Terminal 2 (`cd apps/pipecat-daily-bot && npm run dev`):
- âœ… **Bot Gateway** (http://localhost:4444) - API endpoint
- âœ… **Bot Runner** (http://localhost:7860) - Executes bot sessions

## Verify Everything Works

1. **Open Interface**: http://localhost:3000
2. **Click voice button** (or use keyboard shortcut)
3. **Pearl should join** and start speaking!

## Troubleshooting

### "Runner not available" error
- Make sure `npm run dev` is running in `apps/pipecat-daily-bot`
- Check that runner is on port 7860: `lsof -i :7860`

### "Chorus TTS not found"
- Run: `npm run chorus:download-assets`
- Check Chorus is running: `lsof -i :8000`

### "Bot gateway not responding"
- Check gateway is running: `lsof -i :4444`
- Verify `BOT_CONTROL_BASE_URL=http://localhost:4444` in `.env.local`

### "Daily API error"
- Verify `DAILY_API_KEY` is set correctly
- Check Daily.co dashboard for API key

## Production Setup (with Redis)

If you want to use Redis for multi-user/ngrok:

```bash
# 1. Start Redis
bash scripts/start-redis-dev.sh

# 2. Enable Redis in .env.local
USE_REDIS=true
REDIS_URL=redis://localhost:6379

# 3. Start bot with Redis mode
cd apps/pipecat-daily-bot
npm run dev:redis
```

## Architecture (No Redis)

```
Frontend â†’ /api/bot/join â†’ Gateway (4444) â†’ Runner /start (7860) â†’ Bot Session
                                                                    â†“
                                                              Daily.co Room
                                                                    â†“
                                                              Kokoro TTS (8000)
```

Simple, direct, no queue needed! ðŸŽ‰

