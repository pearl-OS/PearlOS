<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>PearlOS Chat â€” iOS Keyboard Test</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
    --accent: #7c5cbf;
  }

  html, body {
    height: 100%;
    overflow: hidden;
    position: fixed;
    width: 100%;
    background: #0a0a12;
    color: #e0e0e8;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    font-size: 16px;
    -webkit-text-size-adjust: 100%;
    touch-action: manipulation;
  }

  #chat-container {
    display: flex;
    flex-direction: column;
    height: 100%;
    height: 100dvh;
    padding-top: var(--safe-top);
    padding-left: var(--safe-left);
    padding-right: var(--safe-right);
  }

  /* Header */
  .header {
    padding: 12px 16px;
    text-align: center;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    flex-shrink: 0;
  }
  .header h1 { font-size: 18px; font-weight: 600; }
  .header .status { font-size: 12px; color: #888; margin-top: 2px; }

  /* Messages */
  .messages {
    flex: 1;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .bubble {
    max-width: min(85%, calc(100vw - 64px));
    padding: 10px 14px;
    border-radius: 18px;
    font-size: 16px;
    line-height: 1.45;
    word-wrap: break-word;
    overflow-wrap: break-word;
  }
  .bubble.pearl {
    background: rgba(124, 92, 191, 0.25);
    border: 1px solid rgba(124, 92, 191, 0.3);
    align-self: flex-start;
    border-bottom-left-radius: 4px;
  }
  .bubble.user {
    background: rgba(255,255,255,0.12);
    align-self: flex-end;
    border-bottom-right-radius: 4px;
  }

  /* Input bar */
  .input-bar {
    display: flex;
    align-items: flex-end;
    gap: 8px;
    padding: 8px 12px;
    padding-bottom: calc(8px + var(--safe-bottom));
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-top: 1px solid rgba(255,255,255,0.1);
    transition: padding-bottom 0.25s ease-out;
    flex-shrink: 0;
  }
  .input-bar.kb-open {
    padding-bottom: 8px;
  }

  .input-bar textarea {
    flex: 1;
    font-size: 16px;
    line-height: 1.4;
    padding: 10px 14px;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 20px;
    background: rgba(255,255,255,0.1);
    color: #e0e0e8;
    outline: none;
    resize: none;
    min-height: 40px;
    max-height: 120px;
    font-family: inherit;
  }
  .input-bar textarea::placeholder { color: rgba(255,255,255,0.4); }

  .send-btn {
    min-width: 44px; min-height: 44px;
    display: flex; align-items: center; justify-content: center;
    border: none; border-radius: 50%;
    background: var(--accent); color: white;
    font-size: 20px; cursor: pointer;
    touch-action: manipulation;
    flex-shrink: 0;
  }
  .send-btn:active { opacity: 0.7; }

  /* Debug panel */
  .debug {
    position: fixed; top: var(--safe-top); right: 8px;
    background: rgba(0,0,0,0.8); color: #0f0;
    font-size: 11px; font-family: monospace;
    padding: 6px 10px; border-radius: 8px;
    pointer-events: none; z-index: 999;
    line-height: 1.5;
  }

  /* Pearl avatar */
  .pearl-avatar {
    position: fixed;
    bottom: calc(70px + var(--safe-bottom));
    left: calc(12px + var(--safe-left));
    width: 48px; height: 48px;
    border-radius: 50%;
    background: linear-gradient(135deg, #7c5cbf, #b388ff);
    display: flex; align-items: center; justify-content: center;
    font-size: 24px;
    transition: transform 0.25s ease-out, bottom 0.25s ease-out;
    z-index: 10;
    box-shadow: 0 2px 12px rgba(124,92,191,0.4);
  }
  .pearl-avatar.kb-open {
    transform: scale(0.6);
    bottom: calc(60px);
  }
</style>
</head>
<body>
<div id="chat-container">
  <div class="header">
    <h1>ðŸ’Ž Pearl</h1>
    <div class="status" id="status">Ready</div>
  </div>
  <div class="messages" id="messages"></div>
  <div class="input-bar" id="input-bar">
    <textarea id="input" rows="1" placeholder="Message Pearl..." inputmode="text" enterkeyhint="send" autocomplete="off" autocorrect="on"></textarea>
    <button class="send-btn" id="send-btn" aria-label="Send">â†‘</button>
  </div>
</div>

<div class="pearl-avatar" id="pearl-avatar">ðŸ’Ž</div>
<div class="debug" id="debug"></div>

<script>
const container = document.getElementById('chat-container');
const messagesEl = document.getElementById('messages');
const inputBar = document.getElementById('input-bar');
const input = document.getElementById('input');
const sendBtn = document.getElementById('send-btn');
const debugEl = document.getElementById('debug');
const statusEl = document.getElementById('status');
const avatar = document.getElementById('pearl-avatar');

// iOS detection
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && /WebKit/.test(navigator.userAgent);
statusEl.textContent = isIOS ? 'iOS Safari detected' : 'Non-iOS browser';

let fullHeight = window.innerHeight;
let kbOpen = false;

// Seed messages
const seeds = [
  { from: 'pearl', text: 'Hey! ðŸ’Ž I\'m Pearl, your AI companion.' },
  { from: 'pearl', text: 'This is a test page for iOS keyboard handling. Try typing below!' },
  { from: 'user', text: 'Testing the keyboard...' },
  { from: 'pearl', text: 'The input should stay above the keyboard, and messages should scroll smoothly. The layout should never jump or overlap.' },
];
seeds.forEach(m => addMessage(m.from, m.text));
// Add extra messages to make it scrollable
for (let i = 0; i < 15; i++) {
  addMessage(i % 2 ? 'user' : 'pearl', `Test message ${i + 1} â€” checking scroll behavior on long conversations.`);
}
scrollToBottom();

function addMessage(from, text) {
  const div = document.createElement('div');
  div.className = `bubble ${from}`;
  div.textContent = text;
  messagesEl.appendChild(div);
}

function scrollToBottom() {
  requestAnimationFrame(() => {
    messagesEl.scrollTop = messagesEl.scrollHeight;
  });
}

function send() {
  const text = input.value.trim();
  if (!text) return;
  addMessage('user', text);
  input.value = '';
  autoResize();
  scrollToBottom();
  // Fake Pearl reply
  setTimeout(() => {
    addMessage('pearl', `You said: "${text}" â€” keyboard handling working! ðŸŽ‰`);
    scrollToBottom();
  }, 500);
}

// Send on enter (no shift)
input.addEventListener('keydown', (e) => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    send();
  }
});
sendBtn.addEventListener('click', send);

// Prevent tapping outside input from dismissing keyboard
inputBar.addEventListener('mousedown', (e) => {
  if (e.target !== input) e.preventDefault();
});
inputBar.addEventListener('touchstart', (e) => {
  if (e.target !== input) e.preventDefault();
}, { passive: false });

// Auto-resize textarea
function autoResize() {
  input.style.height = 'auto';
  input.style.height = Math.min(input.scrollHeight, 120) + 'px';
}
input.addEventListener('input', autoResize);

// visualViewport keyboard detection
function updateDebug(vvH, kbH) {
  debugEl.textContent = `innerH: ${window.innerHeight} | vvH: ${Math.round(vvH)} | kbH: ${Math.round(kbH)} | iOS: ${isIOS}`;
}

if (window.visualViewport) {
  const vv = window.visualViewport;

  function onResize() {
    const h = vv.height;
    // Update full height when keyboard not visible
    if (Math.abs(h - window.innerHeight) < 100) {
      fullHeight = window.innerHeight;
    }
    const diff = fullHeight - h;
    const open = diff > 150;

    container.style.height = h + 'px';

    if (open !== kbOpen) {
      kbOpen = open;
      inputBar.classList.toggle('kb-open', open);
      avatar.classList.toggle('kb-open', open);
      scrollToBottom();
    }

    updateDebug(h, open ? diff : 0);
  }

  vv.addEventListener('resize', onResize);
  vv.addEventListener('scroll', onResize);
  updateDebug(vv.height, 0);
} else {
  updateDebug(window.innerHeight, 0);
}
</script>
</body>
</html>
