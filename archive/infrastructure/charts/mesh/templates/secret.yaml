{{- if .Values.secret.enabled }}
{{- if .Values.secret.existingSecret }}
# Using existing secret: {{ .Values.secret.existingSecret }}
{{- else if .Values.secret.externalSecret.enabled }}
# External Secret will be managed by External Secrets Operator
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ .Values.secret.externalSecret.name | default (printf "%s-external-secret" (include "mesh.fullname" .)) }}
  namespace: {{ include "mesh.fullname" . }}
  labels:
    {{- include "mesh.labels" . | nindent 4 }}
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: aws-secrets-manager
    kind: ClusterSecretStore
  target:
    name: {{ include "mesh.fullname" . }}-secret
  data:
  - secretKey: POSTGRES_USER
    remoteRef:
      key: nia/{{ include "mesh.fullname" . }}/postgres-user
  - secretKey: POSTGRES_PASSWORD
    remoteRef:
      key: nia/{{ include "mesh.fullname" . }}/postgres-password
  - secretKey: TOKEN_ENCRYPTION_KEY
    remoteRef:
      key: nia/{{ include "mesh.fullname" . }}/token-encryption-key
  - secretKey: MESH_SHARED_SECRET
    remoteRef:
      key: nia/{{ include "mesh.fullname" . }}/mesh-shared-secret
{{- else if .Values.secret.data }}
# Using inline secret data (NOT recommended for production)
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "mesh.fullname" . }}-secret
  namespace: {{ include "mesh.fullname" . }}
  labels:
    {{- include "mesh.labels" . | nindent 4 }}
type: Opaque
data:
  {{- toYaml .Values.secret.data | nindent 2 }}
{{- end }}
{{- end }}
